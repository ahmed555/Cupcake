<link rel="stylesheet" href="/Users/fernyb/php/cupcake/vendors/cupcake/specs/coverage/coverage.css" type="text/css" media="screen" /><div><strong>/Users/fernyb/php/cupcake/vendors/cupcake/dispatcher.php</strong></div><br /><table border="0" cellpadding="0" cellspacing="0"><tr><td class="line-number">0</td><td class="code green"><pre><?php
</pre></td></tr><tr><td class="line-number">1</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">2</td><td class="code green"><pre>class Dispatcher {
</pre></td></tr><tr><td class="line-number">3</td><td class="code red"><pre>  /**
</pre></td></tr><tr><td class="line-number">4</td><td class="code green"><pre> * Base URL
</pre></td></tr><tr><td class="line-number">5</td><td class="code green"><pre> *
</pre></td></tr><tr><td class="line-number">6</td><td class="code green"><pre> * @var string
</pre></td></tr><tr><td class="line-number">7</td><td class="code green"><pre> * @access public
</pre></td></tr><tr><td class="line-number">8</td><td class="code green"><pre> */
</pre></td></tr><tr><td class="line-number">9</td><td class="code green"><pre>	var $base = false;
</pre></td></tr><tr><td class="line-number">10</td><td class="code green"><pre>/**
</pre></td></tr><tr><td class="line-number">11</td><td class="code green"><pre> * webroot path
</pre></td></tr><tr><td class="line-number">12</td><td class="code green"><pre> *
</pre></td></tr><tr><td class="line-number">13</td><td class="code green"><pre> * @var string
</pre></td></tr><tr><td class="line-number">14</td><td class="code green"><pre> * @access public
</pre></td></tr><tr><td class="line-number">15</td><td class="code green"><pre> */
</pre></td></tr><tr><td class="line-number">16</td><td class="code green"><pre>	var $webroot = '/';	
</pre></td></tr><tr><td class="line-number">17</td><td class="code green"><pre>/**
</pre></td></tr><tr><td class="line-number">18</td><td class="code green"><pre> * Current URL
</pre></td></tr><tr><td class="line-number">19</td><td class="code green"><pre> *
</pre></td></tr><tr><td class="line-number">20</td><td class="code green"><pre> * @var string
</pre></td></tr><tr><td class="line-number">21</td><td class="code green"><pre> * @access public
</pre></td></tr><tr><td class="line-number">22</td><td class="code green"><pre> */
</pre></td></tr><tr><td class="line-number">23</td><td class="code green"><pre>	var $here = false;
</pre></td></tr><tr><td class="line-number">24</td><td class="code green"><pre>/**
</pre></td></tr><tr><td class="line-number">25</td><td class="code green"><pre> * the params for this request
</pre></td></tr><tr><td class="line-number">26</td><td class="code green"><pre> *
</pre></td></tr><tr><td class="line-number">27</td><td class="code green"><pre> * @var string
</pre></td></tr><tr><td class="line-number">28</td><td class="code green"><pre> * @access public
</pre></td></tr><tr><td class="line-number">29</td><td class="code green"><pre> */
</pre></td></tr><tr><td class="line-number">30</td><td class="code green"><pre>	var $params = null;
</pre></td></tr><tr><td class="line-number">31</td><td class="code green"><pre>	
</pre></td></tr><tr><td class="line-number">32</td><td class="code green"><pre>	var $output = null;
</pre></td></tr><tr><td class="line-number">33</td><td class="code green"><pre>	
</pre></td></tr><tr><td class="line-number">34</td><td class="code green"><pre>	var $command_line = false;
</pre></td></tr><tr><td class="line-number">35</td><td class="code green"><pre>	
</pre></td></tr><tr><td class="line-number">36</td><td class="code green"><pre>  function dispatch($url = null, $additionalParams = array()) {
</pre></td></tr><tr><td class="line-number">37</td><td class="code green"><pre>  	if ($this->base === false) {
</pre></td></tr><tr><td class="line-number">38</td><td class="code red"><pre>			$this->base = $this->baseUrl();
</pre></td></tr><tr><td class="line-number">39</td><td class="code red"><pre>		}
</pre></td></tr><tr><td class="line-number">40</td><td class="code red"><pre>
</pre></td></tr><tr><td class="line-number">41</td><td class="code green"><pre>		if (is_array($url)) {
</pre></td></tr><tr><td class="line-number">42</td><td class="code red"><pre>			$url = $this->__extractParams($url, $additionalParams);
</pre></td></tr><tr><td class="line-number">43</td><td class="code green"><pre>		} else {
</pre></td></tr><tr><td class="line-number">44</td><td class="code green"><pre>			if ($url) {
</pre></td></tr><tr><td class="line-number">45</td><td class="code red"><pre>				$_GET['url'] = $url;
</pre></td></tr><tr><td class="line-number">46</td><td class="code red"><pre>			}
</pre></td></tr><tr><td class="line-number">47</td><td class="code red"><pre>			$url = $this->getUrl();
</pre></td></tr><tr><td class="line-number">48</td><td class="code red"><pre>			$this->params = array_merge($this->parseParams($url), $additionalParams);
</pre></td></tr><tr><td class="line-number">49</td><td class="code red"><pre>		}
</pre></td></tr><tr><td class="line-number">50</td><td class="code green"><pre>    
</pre></td></tr><tr><td class="line-number">51</td><td class="code green"><pre>		$this->here = $this->base . "/" . $url;
</pre></td></tr><tr><td class="line-number">52</td><td class="code red"><pre>	  
</pre></td></tr><tr><td class="line-number">53</td><td class="code green"><pre>	  $controller = $this->__getController();
</pre></td></tr><tr><td class="line-number">54</td><td class="code red"><pre>
</pre></td></tr><tr><td class="line-number">55</td><td class="code green"><pre>		Router::setRequestInfo(array(
</pre></td></tr><tr><td class="line-number">56</td><td class="code red"><pre>			$this->params, array('base' => $this->base, 'here' => $this->here, 'webroot' => $this->webroot)
</pre></td></tr><tr><td class="line-number">57</td><td class="code red"><pre>		));
</pre></td></tr><tr><td class="line-number">58</td><td class="code red"><pre>	  
</pre></td></tr><tr><td class="line-number">59</td><td class="code green"><pre>	  if(!$controller)  {	    
</pre></td></tr><tr><td class="line-number">60</td><td class="code red"><pre>	    $controller = new ApplicationController();
</pre></td></tr><tr><td class="line-number">61</td><td class="code green"><pre>	    $this->_invoke($controller, $this->params, true);
</pre></td></tr><tr><td class="line-number">62</td><td class="code green"><pre>	    return;
</pre></td></tr><tr><td class="line-number">63</td><td class="code green"><pre>	  }
</pre></td></tr><tr><td class="line-number">64</td><td class="code green"><pre>	  	
</pre></td></tr><tr><td class="line-number">65</td><td class="code green"><pre>		$controller->base = $this->base;
</pre></td></tr><tr><td class="line-number">66</td><td class="code red"><pre>		$controller->here = $this->here;
</pre></td></tr><tr><td class="line-number">67</td><td class="code red"><pre>		$controller->webroot = $this->webroot;
</pre></td></tr><tr><td class="line-number">68</td><td class="code red"><pre>		$controller->params = $this->params;
</pre></td></tr><tr><td class="line-number">69</td><td class="code red"><pre>		$controller->action = $this->params['action'];
</pre></td></tr><tr><td class="line-number">70</td><td class="code red"><pre>  		
</pre></td></tr><tr><td class="line-number">71</td><td class="code green"><pre>		if (!empty($this->params['data'])) {
</pre></td></tr><tr><td class="line-number">72</td><td class="code red"><pre>			$controller->data = $this->params['data'];
</pre></td></tr><tr><td class="line-number">73</td><td class="code green"><pre>		} else {
</pre></td></tr><tr><td class="line-number">74</td><td class="code green"><pre>			$controller->data = null;
</pre></td></tr><tr><td class="line-number">75</td><td class="code red"><pre>		}	
</pre></td></tr><tr><td class="line-number">76</td><td class="code green"><pre>		$this->_invoke($controller, $this->params);
</pre></td></tr><tr><td class="line-number">77</td><td class="code red"><pre>  
</pre></td></tr><tr><td class="line-number">78</td><td class="code green"><pre>  }
</pre></td></tr><tr><td class="line-number">79</td><td class="code red"><pre>
</pre></td></tr><tr><td class="line-number">80</td><td class="code green"><pre>/**
</pre></td></tr><tr><td class="line-number">81</td><td class="code green"><pre>* This is where things get returned to the browser
</pre></td></tr><tr><td class="line-number">82</td><td class="code green"><pre>*/
</pre></td></tr><tr><td class="line-number">83</td><td class="code green"><pre>  function _invoke($controller, $params, $action_missing=false) {
</pre></td></tr><tr><td class="line-number">84</td><td class="code green"><pre> 
</pre></td></tr><tr><td class="line-number">85</td><td class="code green"><pre>		$keys = array_flip(get_class_methods($controller));
</pre></td></tr><tr><td class="line-number">86</td><td class="code red"><pre>		
</pre></td></tr><tr><td class="line-number">87</td><td class="code green"><pre>		if(array_key_exists($params["action"], $keys)) {
</pre></td></tr><tr><td class="line-number">88</td><td class="code red"><pre>		  // Do something here when the action exists perhaps call the action?
</pre></td></tr><tr><td class="line-number">89</td><td class="code green"><pre>		  $this->output = $controller->render($params['action'], $params['controller'], $params['action']);
</pre></td></tr><tr><td class="line-number">90</td><td class="code green"><pre>		} else if($action_missing == true){
</pre></td></tr><tr><td class="line-number">91</td><td class="code red"><pre>		  $this->output = $controller->render("missing_action", "missing", $params['action']);
</pre></td></tr><tr><td class="line-number">92</td><td class="code green"><pre>		} else if($action_missing == false) {
</pre></td></tr><tr><td class="line-number">93</td><td class="code red"><pre>		  $this->output = $controller->render("missing_action", $params['controller'], $params['action']);		  
</pre></td></tr><tr><td class="line-number">94</td><td class="code red"><pre>		}
</pre></td></tr><tr><td class="line-number">95</td><td class="code red"><pre>		
</pre></td></tr><tr><td class="line-number">96</td><td class="code green"><pre>		if($this->command_line) {
</pre></td></tr><tr><td class="line-number">97</td><td class="code red"><pre>		  // Don't output the content if it's from the command line 
</pre></td></tr><tr><td class="line-number">98</td><td class="code green"><pre>		} else {
</pre></td></tr><tr><td class="line-number">99</td><td class="code red"><pre>		  // Since it's not from the command line output the content
</pre></td></tr><tr><td class="line-number">100</td><td class="code green"><pre>		  echo $this->output;
</pre></td></tr><tr><td class="line-number">101</td><td class="code green"><pre>		}
</pre></td></tr><tr><td class="line-number">102</td><td class="code green"><pre>  }
</pre></td></tr><tr><td class="line-number">103</td><td class="code red"><pre>
</pre></td></tr><tr><td class="line-number">104</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">105</td><td class="code green"><pre>	function getUrl($uri = null, $base = null) {
</pre></td></tr><tr><td class="line-number">106</td><td class="code green"><pre>		if (empty($_GET['url'])) {
</pre></td></tr><tr><td class="line-number">107</td><td class="code red"><pre>			if ($uri == null) {
</pre></td></tr><tr><td class="line-number">108</td><td class="code green"><pre>				$uri = $this->uri();
</pre></td></tr><tr><td class="line-number">109</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">110</td><td class="code green"><pre>			if ($base == null) {
</pre></td></tr><tr><td class="line-number">111</td><td class="code green"><pre>				$base = $this->base;
</pre></td></tr><tr><td class="line-number">112</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">113</td><td class="code green"><pre>			$url = null;
</pre></td></tr><tr><td class="line-number">114</td><td class="code green"><pre>			$tmpUri = preg_replace('/^(?:\?)?(?:\/)?/', '', $uri);
</pre></td></tr><tr><td class="line-number">115</td><td class="code green"><pre>			$baseDir = preg_replace('/^\//', '', dirname($base)) . '/';
</pre></td></tr><tr><td class="line-number">116</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">117</td><td class="code green"><pre>			if ($tmpUri === '/' || $tmpUri == $baseDir || $tmpUri == $base) {
</pre></td></tr><tr><td class="line-number">118</td><td class="code green"><pre>				$url = $_GET['url'] = '/';
</pre></td></tr><tr><td class="line-number">119</td><td class="code green"><pre>			} else {
</pre></td></tr><tr><td class="line-number">120</td><td class="code green"><pre>				if ($base && strpos($uri, $base) !== false) {
</pre></td></tr><tr><td class="line-number">121</td><td class="code green"><pre>					$elements = explode($base, $uri);
</pre></td></tr><tr><td class="line-number">122</td><td class="code green"><pre>				} elseif (preg_match('/^[\/\?\/|\/\?|\?\/]/', $uri)) {
</pre></td></tr><tr><td class="line-number">123</td><td class="code green"><pre>					$elements = array(1 => preg_replace('/^[\/\?\/|\/\?|\?\/]/', '', $uri));
</pre></td></tr><tr><td class="line-number">124</td><td class="code green"><pre>				} else {
</pre></td></tr><tr><td class="line-number">125</td><td class="code green"><pre>					$elements = array();
</pre></td></tr><tr><td class="line-number">126</td><td class="code green"><pre>				}
</pre></td></tr><tr><td class="line-number">127</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">128</td><td class="code green"><pre>				if (!empty($elements[1])) {
</pre></td></tr><tr><td class="line-number">129</td><td class="code green"><pre>					$_GET['url'] = $elements[1];
</pre></td></tr><tr><td class="line-number">130</td><td class="code green"><pre>					$url = $elements[1];
</pre></td></tr><tr><td class="line-number">131</td><td class="code green"><pre>				} else {
</pre></td></tr><tr><td class="line-number">132</td><td class="code green"><pre>					$url = $_GET['url'] = '/';
</pre></td></tr><tr><td class="line-number">133</td><td class="code green"><pre>				}
</pre></td></tr><tr><td class="line-number">134</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">135</td><td class="code green"><pre>				if (strpos($url, '/') === 0 && $url != '/') {
</pre></td></tr><tr><td class="line-number">136</td><td class="code green"><pre>					$url = $_GET['url'] = substr($url, 1);
</pre></td></tr><tr><td class="line-number">137</td><td class="code green"><pre>				}
</pre></td></tr><tr><td class="line-number">138</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">139</td><td class="code green"><pre>		} else {
</pre></td></tr><tr><td class="line-number">140</td><td class="code green"><pre>			$url = $_GET['url'];
</pre></td></tr><tr><td class="line-number">141</td><td class="code red"><pre>		}
</pre></td></tr><tr><td class="line-number">142</td><td class="code green"><pre>		if ($url{0} == '/') {
</pre></td></tr><tr><td class="line-number">143</td><td class="code red"><pre>			$url = substr($url, 1);
</pre></td></tr><tr><td class="line-number">144</td><td class="code green"><pre>		}
</pre></td></tr><tr><td class="line-number">145</td><td class="code green"><pre>		return $url;
</pre></td></tr><tr><td class="line-number">146</td><td class="code red"><pre>	}
</pre></td></tr><tr><td class="line-number">147</td><td class="code green"><pre>  
</pre></td></tr><tr><td class="line-number">148</td><td class="code green"><pre>  
</pre></td></tr><tr><td class="line-number">149</td><td class="code green"><pre>  function __extractParams($url, $additionalParams) {
</pre></td></tr><tr><td class="line-number">150</td><td class="code green"><pre>    
</pre></td></tr><tr><td class="line-number">151</td><td class="code green"><pre>  }
</pre></td></tr><tr><td class="line-number">152</td><td class="code green"><pre>  
</pre></td></tr><tr><td class="line-number">153</td><td class="code green"><pre>  function parseParams($fromUrl) {
</pre></td></tr><tr><td class="line-number">154</td><td class="code green"><pre>    $params = array();
</pre></td></tr><tr><td class="line-number">155</td><td class="code red"><pre>    include CONFIGS . 'routes.php';
</pre></td></tr><tr><td class="line-number">156</td><td class="code red"><pre>		$params = array_merge(Router::parse($fromUrl), $params);
</pre></td></tr><tr><td class="line-number">157</td><td class="code red"><pre>	
</pre></td></tr><tr><td class="line-number">158</td><td class="code green"><pre>		if (strlen($params['action']) === 0) {
</pre></td></tr><tr><td class="line-number">159</td><td class="code red"><pre>			$params['action'] = 'index';
</pre></td></tr><tr><td class="line-number">160</td><td class="code green"><pre>		}
</pre></td></tr><tr><td class="line-number">161</td><td class="code green"><pre>	 
</pre></td></tr><tr><td class="line-number">162</td><td class="code green"><pre>	 if (isset($_GET)) {
</pre></td></tr><tr><td class="line-number">163</td><td class="code red"><pre>			$url = (ini_get('magic_quotes_gpc') === '1' ? stripslashes_deep($_GET) : $_GET );
</pre></td></tr><tr><td class="line-number">164</td><td class="code red"><pre>			if (isset($params['url'])) {
</pre></td></tr><tr><td class="line-number">165</td><td class="code red"><pre>				$params['url'] = array_merge($params['url'], $url);
</pre></td></tr><tr><td class="line-number">166</td><td class="code green"><pre>			} else {
</pre></td></tr><tr><td class="line-number">167</td><td class="code green"><pre>				$params['url'] = $url;
</pre></td></tr><tr><td class="line-number">168</td><td class="code red"><pre>			}
</pre></td></tr><tr><td class="line-number">169</td><td class="code green"><pre>		}	
</pre></td></tr><tr><td class="line-number">170</td><td class="code red"><pre>		
</pre></td></tr><tr><td class="line-number">171</td><td class="code green"><pre>		return $params;
</pre></td></tr><tr><td class="line-number">172</td><td class="code red"><pre>  }
</pre></td></tr><tr><td class="line-number">173</td><td class="code green"><pre>  
</pre></td></tr><tr><td class="line-number">174</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">175</td><td class="code green"><pre>/**
</pre></td></tr><tr><td class="line-number">176</td><td class="code green"><pre> * Get controller to use, either plugin controller or application controller
</pre></td></tr><tr><td class="line-number">177</td><td class="code green"><pre> *
</pre></td></tr><tr><td class="line-number">178</td><td class="code green"><pre> * @param array $params Array of parameters
</pre></td></tr><tr><td class="line-number">179</td><td class="code green"><pre> * @return mixed name of controller if not loaded, or object if loaded
</pre></td></tr><tr><td class="line-number">180</td><td class="code green"><pre> * @access private
</pre></td></tr><tr><td class="line-number">181</td><td class="code green"><pre> */
</pre></td></tr><tr><td class="line-number">182</td><td class="code green"><pre>	function &__getController($params = null) {
</pre></td></tr><tr><td class="line-number">183</td><td class="code green"><pre>		if (!is_array($params)) {
</pre></td></tr><tr><td class="line-number">184</td><td class="code red"><pre>			$original = $params = $this->params;
</pre></td></tr><tr><td class="line-number">185</td><td class="code red"><pre>		}
</pre></td></tr><tr><td class="line-number">186</td><td class="code red"><pre>		
</pre></td></tr><tr><td class="line-number">187</td><td class="code green"><pre>		$controller = false;
</pre></td></tr><tr><td class="line-number">188</td><td class="code red"><pre>		
</pre></td></tr><tr><td class="line-number">189</td><td class="code green"><pre>		$ctrlClass = Inflector::camelize($params['controller']);
</pre></td></tr><tr><td class="line-number">190</td><td class="code red"><pre>	  $ctrlClass = $ctrlClass . 'Controller';
</pre></td></tr><tr><td class="line-number">191</td><td class="code red"><pre>	
</pre></td></tr><tr><td class="line-number">192</td><td class="code green"><pre>	  if($this->__loadControllerFile($ctrlClass)) {
</pre></td></tr><tr><td class="line-number">193</td><td class="code red"><pre>	    $controller = new $ctrlClass();
</pre></td></tr><tr><td class="line-number">194</td><td class="code red"><pre>	  } else {
</pre></td></tr><tr><td class="line-number">195</td><td class="code red"><pre>	    $controller = false;
</pre></td></tr><tr><td class="line-number">196</td><td class="code red"><pre>	  }
</pre></td></tr><tr><td class="line-number">197</td><td class="code green"><pre>	
</pre></td></tr><tr><td class="line-number">198</td><td class="code green"><pre>		return $controller;
</pre></td></tr><tr><td class="line-number">199</td><td class="code red"><pre>	}
</pre></td></tr><tr><td class="line-number">200</td><td class="code green"><pre>  
</pre></td></tr><tr><td class="line-number">201</td><td class="code green"><pre>  function __loadControllerFile($className=null) {
</pre></td></tr><tr><td class="line-number">202</td><td class="code green"><pre>    $app_dir = APP_BASE_URL . DS . "controllers" . DS;
</pre></td></tr><tr><td class="line-number">203</td><td class="code red"><pre>    if(!class_exists("ApplicationController")) {
</pre></td></tr><tr><td class="line-number">204</td><td class="code red"><pre>      @include_once $app_dir . "application_controller.php";
</pre></td></tr><tr><td class="line-number">205</td><td class="code red"><pre>    }
</pre></td></tr><tr><td class="line-number">206</td><td class="code red"><pre>    if(!class_exists("ApplicationController")) {
</pre></td></tr><tr><td class="line-number">207</td><td class="code red"><pre>      return false;
</pre></td></tr><tr><td class="line-number">208</td><td class="code green"><pre>    }
</pre></td></tr><tr><td class="line-number">209</td><td class="code green"><pre>    
</pre></td></tr><tr><td class="line-number">210</td><td class="code green"><pre>    $name = Inflector::underscore($className);
</pre></td></tr><tr><td class="line-number">211</td><td class="code red"><pre>    $file_path = $app_dir . $name . ".php";
</pre></td></tr><tr><td class="line-number">212</td><td class="code red"><pre>    @include_once $file_path;
</pre></td></tr><tr><td class="line-number">213</td><td class="code red"><pre>    
</pre></td></tr><tr><td class="line-number">214</td><td class="code green"><pre>    if(!class_exists($className)) {
</pre></td></tr><tr><td class="line-number">215</td><td class="code red"><pre>      return false;
</pre></td></tr><tr><td class="line-number">216</td><td class="code red"><pre>    } else {
</pre></td></tr><tr><td class="line-number">217</td><td class="code green"><pre>      return true;
</pre></td></tr><tr><td class="line-number">218</td><td class="code red"><pre>    }
</pre></td></tr><tr><td class="line-number">219</td><td class="code green"><pre>  }
</pre></td></tr><tr><td class="line-number">220</td><td class="code green"><pre>  
</pre></td></tr><tr><td class="line-number">221</td><td class="code green"><pre>  /**
</pre></td></tr><tr><td class="line-number">222</td><td class="code green"><pre> * Returns the REQUEST_URI from the server environment, or, failing that,
</pre></td></tr><tr><td class="line-number">223</td><td class="code green"><pre> * constructs a new one, using the PHP_SELF constant and other variables.
</pre></td></tr><tr><td class="line-number">224</td><td class="code green"><pre> *
</pre></td></tr><tr><td class="line-number">225</td><td class="code green"><pre> * TODO: It really needs to be broken down into smaller methods, so testing it can be
</pre></td></tr><tr><td class="line-number">226</td><td class="code green"><pre> * much easier.
</pre></td></tr><tr><td class="line-number">227</td><td class="code green"><pre> *  
</pre></td></tr><tr><td class="line-number">228</td><td class="code green"><pre> * @return string URI
</pre></td></tr><tr><td class="line-number">229</td><td class="code green"><pre> * @access public
</pre></td></tr><tr><td class="line-number">230</td><td class="code green"><pre> */
</pre></td></tr><tr><td class="line-number">231</td><td class="code green"><pre>	function uri() {
</pre></td></tr><tr><td class="line-number">232</td><td class="code green"><pre>		foreach (array('HTTP_X_REWRITE_URL', 'REQUEST_URI', 'argv') as $var) {
</pre></td></tr><tr><td class="line-number">233</td><td class="code red"><pre>			if ($uri = env($var)) {
</pre></td></tr><tr><td class="line-number">234</td><td class="code red"><pre>				if ($var == 'argv') {
</pre></td></tr><tr><td class="line-number">235</td><td class="code red"><pre>					$uri = $uri[0];
</pre></td></tr><tr><td class="line-number">236</td><td class="code red"><pre>				}
</pre></td></tr><tr><td class="line-number">237</td><td class="code red"><pre>				break;
</pre></td></tr><tr><td class="line-number">238</td><td class="code red"><pre>			}
</pre></td></tr><tr><td class="line-number">239</td><td class="code green"><pre>		}
</pre></td></tr><tr><td class="line-number">240</td><td class="code red"><pre>	  
</pre></td></tr><tr><td class="line-number">241</td><td class="code green"><pre>		$base = preg_replace('/^\//', '', '' . APP_BASE_URL);
</pre></td></tr><tr><td class="line-number">242</td><td class="code red"><pre>  
</pre></td></tr><tr><td class="line-number">243</td><td class="code green"><pre>		if ($base) {
</pre></td></tr><tr><td class="line-number">244</td><td class="code red"><pre>			$uri = preg_replace('/^(?:\/)?(?:' . preg_quote($base, '/') . ')?(?:url=)?/', '', $uri);
</pre></td></tr><tr><td class="line-number">245</td><td class="code red"><pre>		}
</pre></td></tr><tr><td class="line-number">246</td><td class="code red"><pre>		if (PHP_SAPI == 'isapi') {
</pre></td></tr><tr><td class="line-number">247</td><td class="code red"><pre>			$uri = preg_replace('/^(?:\/)?(?:\/)?(?:\?)?(?:url=)?/', '', $uri);
</pre></td></tr><tr><td class="line-number">248</td><td class="code green"><pre>		}
</pre></td></tr><tr><td class="line-number">249</td><td class="code green"><pre>		if (!empty($uri)) {
</pre></td></tr><tr><td class="line-number">250</td><td class="code red"><pre>			if (key($_GET) && strpos(key($_GET), '?') !== false) {
</pre></td></tr><tr><td class="line-number">251</td><td class="code red"><pre>				unset($_GET[key($_GET)]);
</pre></td></tr><tr><td class="line-number">252</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">253</td><td class="code green"><pre>		
</pre></td></tr><tr><td class="line-number">254</td><td class="code green"><pre>			$uri = preg_split('/\?/', $uri, 2);
</pre></td></tr><tr><td class="line-number">255</td><td class="code red"><pre>      
</pre></td></tr><tr><td class="line-number">256</td><td class="code green"><pre>			if (isset($uri[1])) {
</pre></td></tr><tr><td class="line-number">257</td><td class="code red"><pre>				parse_str($uri[1], $_GET);
</pre></td></tr><tr><td class="line-number">258</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">259</td><td class="code green"><pre>			
</pre></td></tr><tr><td class="line-number">260</td><td class="code green"><pre>			$uri = $uri[0];
</pre></td></tr><tr><td class="line-number">261</td><td class="code red"><pre>		} elseif (empty($uri) && is_string(env('QUERY_STRING'))) {
</pre></td></tr><tr><td class="line-number">262</td><td class="code red"><pre>			$uri = env('QUERY_STRING');
</pre></td></tr><tr><td class="line-number">263</td><td class="code green"><pre>		}
</pre></td></tr><tr><td class="line-number">264</td><td class="code green"><pre>		
</pre></td></tr><tr><td class="line-number">265</td><td class="code green"><pre>		if (strpos($uri, 'index.php') !== false) {
</pre></td></tr><tr><td class="line-number">266</td><td class="code red"><pre>			list(, $uri) = explode('index.php', $uri, 2);
</pre></td></tr><tr><td class="line-number">267</td><td class="code green"><pre>		}
</pre></td></tr><tr><td class="line-number">268</td><td class="code green"><pre>		if (empty($uri) || $uri == '/' || $uri == '//') {
</pre></td></tr><tr><td class="line-number">269</td><td class="code red"><pre>			return '';
</pre></td></tr><tr><td class="line-number">270</td><td class="code green"><pre>		}
</pre></td></tr><tr><td class="line-number">271</td><td class="code green"><pre>		
</pre></td></tr><tr><td class="line-number">272</td><td class="code green"><pre>		return str_replace('//', '/', '/' . $uri);
</pre></td></tr><tr><td class="line-number">273</td><td class="code red"><pre>	}
</pre></td></tr><tr><td class="line-number">274</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">275</td><td class="code green"><pre>/**
</pre></td></tr><tr><td class="line-number">276</td><td class="code green"><pre> * Returns a base URL and sets the proper webroot
</pre></td></tr><tr><td class="line-number">277</td><td class="code green"><pre> *
</pre></td></tr><tr><td class="line-number">278</td><td class="code green"><pre> * @return string Base URL
</pre></td></tr><tr><td class="line-number">279</td><td class="code green"><pre> * @access public
</pre></td></tr><tr><td class="line-number">280</td><td class="code green"><pre> */  
</pre></td></tr><tr><td class="line-number">281</td><td class="code green"><pre>	function baseUrl() {
</pre></td></tr><tr><td class="line-number">282</td><td class="code green"><pre>		$dir = $webroot = null;
</pre></td></tr><tr><td class="line-number">283</td><td class="code red"><pre>		$config = array('base' => false, 'baseUrl' => false, 'dir' => APP_DIR, 'webroot' => WEBROOT_DIR);
</pre></td></tr><tr><td class="line-number">284</td><td class="code red"><pre>	
</pre></td></tr><tr><td class="line-number">285</td><td class="code green"><pre>	  if(!is_array($config)) {
</pre></td></tr><tr><td class="line-number">286</td><td class="code red"><pre>      $config = array();
</pre></td></tr><tr><td class="line-number">287</td><td class="code green"><pre>	  }
</pre></td></tr><tr><td class="line-number">288</td><td class="code green"><pre>		extract($config);
</pre></td></tr><tr><td class="line-number">289</td><td class="code red"><pre>	  
</pre></td></tr><tr><td class="line-number">290</td><td class="code green"><pre>		if (!$base) {
</pre></td></tr><tr><td class="line-number">291</td><td class="code red"><pre>			$base = $this->base;
</pre></td></tr><tr><td class="line-number">292</td><td class="code red"><pre>		}
</pre></td></tr><tr><td class="line-number">293</td><td class="code red"><pre>		if ($base !== false) {
</pre></td></tr><tr><td class="line-number">294</td><td class="code red"><pre>			$this->webroot = $base . '/';
</pre></td></tr><tr><td class="line-number">295</td><td class="code green"><pre>			return $this->base = $base;
</pre></td></tr><tr><td class="line-number">296</td><td class="code green"><pre>		}
</pre></td></tr><tr><td class="line-number">297</td><td class="code green"><pre>		
</pre></td></tr><tr><td class="line-number">298</td><td class="code green"><pre>		if (!$baseUrl) {
</pre></td></tr><tr><td class="line-number">299</td><td class="code red"><pre>			$replace = array('<', '>', '*', '\'', '"');
</pre></td></tr><tr><td class="line-number">300</td><td class="code red"><pre>			$base = str_replace($replace, '', dirname(env('PHP_SELF')));
</pre></td></tr><tr><td class="line-number">301</td><td class="code red"><pre>      
</pre></td></tr><tr><td class="line-number">302</td><td class="code green"><pre>      if ($webroot === 'webroot' && $webroot === basename($base)) {
</pre></td></tr><tr><td class="line-number">303</td><td class="code red"><pre>				$base = dirname($base);
</pre></td></tr><tr><td class="line-number">304</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">305</td><td class="code green"><pre>			
</pre></td></tr><tr><td class="line-number">306</td><td class="code green"><pre>			if ($webroot === 'public' && $webroot === basename($base)) {
</pre></td></tr><tr><td class="line-number">307</td><td class="code red"><pre>				$base = dirname($base);
</pre></td></tr><tr><td class="line-number">308</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">309</td><td class="code green"><pre>			
</pre></td></tr><tr><td class="line-number">310</td><td class="code green"><pre>			if ($dir === 'app' && $dir === basename($base)) {
</pre></td></tr><tr><td class="line-number">311</td><td class="code red"><pre>				$base = dirname($base);
</pre></td></tr><tr><td class="line-number">312</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">313</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">314</td><td class="code green"><pre>			if ($base === DS || $base === '.') {
</pre></td></tr><tr><td class="line-number">315</td><td class="code red"><pre>				$base = '';
</pre></td></tr><tr><td class="line-number">316</td><td class="code red"><pre>			}
</pre></td></tr><tr><td class="line-number">317</td><td class="code red"><pre>      
</pre></td></tr><tr><td class="line-number">318</td><td class="code green"><pre>			$this->webroot = $base .'/';
</pre></td></tr><tr><td class="line-number">319</td><td class="code red"><pre>			return $base;
</pre></td></tr><tr><td class="line-number">320</td><td class="code red"><pre>		}
</pre></td></tr><tr><td class="line-number">321</td><td class="code green"><pre>		
</pre></td></tr><tr><td class="line-number">322</td><td class="code green"><pre>		$file = null;
</pre></td></tr><tr><td class="line-number">323</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">324</td><td class="code green"><pre>		if ($baseUrl) {
</pre></td></tr><tr><td class="line-number">325</td><td class="code green"><pre>			$file = '/' . basename($baseUrl);
</pre></td></tr><tr><td class="line-number">326</td><td class="code green"><pre>			$base = dirname($baseUrl);
</pre></td></tr><tr><td class="line-number">327</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">328</td><td class="code green"><pre>			if ($base === DS || $base === '.') {
</pre></td></tr><tr><td class="line-number">329</td><td class="code green"><pre>				$base = '';
</pre></td></tr><tr><td class="line-number">330</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">331</td><td class="code green"><pre>			$this->webroot = $base .'/';
</pre></td></tr><tr><td class="line-number">332</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">333</td><td class="code green"><pre>			if (strpos($this->webroot, $dir) === false) {
</pre></td></tr><tr><td class="line-number">334</td><td class="code green"><pre>				$this->webroot .= $dir . '/' ;
</pre></td></tr><tr><td class="line-number">335</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">336</td><td class="code green"><pre>			if (strpos($this->webroot, $webroot) === false) {
</pre></td></tr><tr><td class="line-number">337</td><td class="code green"><pre>				$this->webroot .= $webroot . '/';
</pre></td></tr><tr><td class="line-number">338</td><td class="code green"><pre>			}
</pre></td></tr><tr><td class="line-number">339</td><td class="code green"><pre>			return $base . $file;
</pre></td></tr><tr><td class="line-number">340</td><td class="code green"><pre>		}
</pre></td></tr><tr><td class="line-number">341</td><td class="code green"><pre>		return false;
</pre></td></tr><tr><td class="line-number">342</td><td class="code green"><pre>	}
</pre></td></tr><tr><td class="line-number">343</td><td class="code green"><pre>	
</pre></td></tr><tr><td class="line-number">344</td><td class="code green"><pre>}
</pre></td></tr><tr><td class="line-number">345</td><td class="code green"><pre>
</pre></td></tr><tr><td class="line-number">346</td><td class="code green"><pre>?></pre></td></tr></table>